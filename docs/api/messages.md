# Работа с сообщениями

## 1. Отправка сообщения

### Opcode — `64`

#### Пример запроса

```json
{
  "ver": 11,
  "cmd": 0,
  "seq": 59,
  "opcode": 64,
  "payload": {
    "chatId": 0,
    "message": {
      "text": "тест1",
      "cid": 1755111111111,
      "elements": [],
      "attaches": []
    },
    "notify": true
  }
}
```


#### Параметры запроса

| Аргумент           | Тип    | Обязательный | Описание                                                |
|:----------------- | :-----: | :----------: | :------------------------------------------------------ |
| `chatId`           | int    | ✅           | ID чата (например: `0` — избранное)                     |
| `message.text`     | string | ✅           | Текст сообщения                                         |
| `message.cid`      | int    | ✅           | Клиентский ID / таймстамп в миллисекундах (timestamp ms) |
| `message.elements` | array  | ✅           | Дополнительные элементы (передавать пустым массивом)    |
| `message.attaches` | array  | ✅           | Вложения (массив объектов; примеры ниже)                |
| `notify`           | bool   | ✅           | Нужно ли отправлять push-уведомление (`true` / `false`) |


#### Пример ответа

```json
{
  "ver": 11,
  "cmd": 1,
  "seq": 30,
  "opcode": 64,
  "payload": {
    "chatId": 0,
    "message": {
      "sender": 11111111,
      "id": "111111111111111111",
      "time": 1755111111111,
      "text": "тест",
      "type": "USER",
      "cid": 1755111111111,
      "attaches": []
    }
  }
}
```


#### Параметры ответа

| Аргумент             | Тип    | Описание                             |
| :------------------- | :-----: | :----------------------------------- |
| `chatId`             | int    | ID чата, куда доставлено сообщение   |
| `message.sender`     | int    | ID отправителя сообщения             |
| `message.id`         | string | Уникальный идентификатор сообщения   |
| `message.time`       | int    | Время отправки (timestamp в ms)      |
| `message.text`       | string | Текст сообщения                      |
| `message.type`       | string | Тип сообщения (например: `USER`)     |
| `message.cid`        | int    | Клиентский ID (timestamp из запроса) |
| `message.attaches`   | array  | Массив вложений (если есть)          |

---

## 2. Отправка сообщения с вложением (картинка)

### Шаг 1 — Получение ссылки для загрузки изображения

### Opcode — `80`

#### Пример запроса

```json
{
  "ver": 11,
  "cmd": 0,
  "seq": 47,
  "opcode": 80,
  "payload": {
    "count": 1
  }
}
```


#### Параметры запроса

| Аргумент | Тип | Обязательный | Описание            |
| :--------| :---:| :-----------: | :------------------ |
| `count`  | int | ✅           | Количество вложений |

#### Пример ответа

```json
{
  "ver": 11,
  "cmd": 1,
  "seq": 47,
  "opcode": 80,
  "payload": {
    "url": "https://iu.oneme.ru/uploadImage?apiToken=j5wa...%3D%3D&photoIds=izs...%3D%3D"
  }
}
```

#### Параметры ответа

| Аргумент | Тип | Описание                          |
| :--------| :---:| :-------------------------------- |
| `url`    | str | Ссылка для загрузки фото (upload) |

### Шаг 2 — Загрузка фото на полученную ссылку

> Примечание: URL, который вернул сервер на шаге 1, — это конечная ссылка, на которую нужно отправлять POST-запрос с multipart/form-data.

#### HTTP запрос (пример)

```
POST https://iu.oneme.ru/uploadImage?apiToken=<token>&photoIds=<photoId> HTTP/1.1
Host: iu.oneme.ru
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryGlQwgqr9Oj7q5CRZ
Accept: */*
Referrer: https://web.max.ru/

--boundary
Content-Disposition: form-data; name="file"; filename="image.jpg"
Content-Type: image/jpeg

<байты изображения>
--boundary--
```

##### Форма

| Аргумент | Тип   | Обязательный | Описание         |
| :--------| :----: | :-----------: | :--------------- |
| `file`   | bytes | ✅           | Файл изображения |

#### Пример ответа от сервера загрузки

```json
{
  "photos": {
    "izsP0kkIEnX8ejlEIhPCgAkvFZuVqFVn8wNF7ve0fLHyjGE6N5vBtw==": {
      "token": "RycGq8rBm/...1UGLWo4Qu"
    }
  }
}
```

#### Параметры ответа

| Аргумент             | Тип | Описание                                                  |
| :------------------- | :---:| :-------------------------------------------------------- |
| `photos`             | obj | Объект с результатами по каждому загруженному фото        |
| `photos.[id].token`  | str | Токен, который используется для привязки фото к сообщению |

### Шаг 3 — Отправка сообщения с прикреплённой фотографией

#### Пример запроса

```json
{
  "ver": 11,
  "cmd": 0,
  "seq": 59,
  "opcode": 64,
  "payload": {
    "chatId": 0,
    "message": {
      "text": "тест1",
      "cid": 1755111111111,
      "elements": [],
      "attaches": [
        {
          "_type": "PHOTO",
          "photoToken": "RycGq8rBm/...1UGLWo4Qu"
        }
      ]
    },
    "notify": true
  }
}
```

#### Параметры запроса

| Аргумент                      | Тип | Обязательный | Описание                              |
| :---------------------------- | :---:| :-----------: | :------------------------------------ |
| `message.attaches.[0]._type`  | str | ✅           | Тип вложения (например: `PHOTO`)      |
| `message.attaches.[0].photoToken` | str | ✅       | Токен фото, полученный после загрузки |

---

## 3. Изменение сообщения

### Opcode — `67`

#### Пример запроса

```json
{
  "ver": 11,
  "cmd": 0,
  "seq": 25,
  "opcode": 67,
  "payload": {
    "chatId": 0,
    "messageId": "111111111111111111",
    "text": "тест123",
    "elements": [],
    "attachments": []
  }
}
```

> Примечание: операция редактирования почти идентична отправке сообщения, но требует указания `messageId`.

#### Пример ответа

```json
{
  "ver": 11,
  "cmd": 1,
  "seq": 25,
  "opcode": 67,
  "payload": {
    "message": {
      "sender": 11111111,
      "reactionInfo": {},
      "updateTime": 1755111111111,
      "id": "111111111111111111",
      "time": 1755111111111,
      "text": "тест123",
      "type": "USER",
      "status": "EDITED",
      "cid": 1755111111111,
      "attaches": []
    }
  }
}
```

#### Параметры ответа

| Аргумент               | Тип | Описание                                       |
| :--------------------- | :---:| :--------------------------------------------- |
| `message.reactionInfo` | obj | Информация о реакциях на сообщение (если есть) |
| `message.status`       | str | Статус сообщения (`EDITED` и т.д.)             |

---

## 4. Удаление сообщения

### Opcode — `66`

#### Пример запроса

```json
{
  "ver": 11,
  "cmd": 0,
  "seq": 17,
  "opcode": 66,
  "payload": {
    "chatId": 0,
    "messageIds": [
      "111111111111111111"
    ],
    "forMe": true
  }
}
```

#### Параметры запроса

| Аргумент     | Тип           | Обязательный | Описание                                         |
| :----------- | :------------: | :-----------: | :----------------------------------------------- |
| `chatId`     | int           | ✅           | ID чата, где находится сообщение                 |
| `messageIds` | array[string] | ✅           | Список ID сообщений для удаления                 |
| `forMe`      | bool          | ✅           | `true` — удалить только у себя; `false` — у всех |

#### Пример ответа

```json
{
  "ver": 11,
  "cmd": 1,
  "seq": 17,
  "opcode": 66,
  "payload": {
    "chatId": 0,
    "messageIds": [
      "111111111111111111"
    ]
  }
}
```

#### Параметры ответа

| Аргумент     | Тип           | Описание                         |
| :----------- | :------------: | :------------------------------- |
| `chatId`     | int           | ID чата, где удалилось сообщение |
| `messageIds` | array[string] | Массив ID удалённых сообщений    |

---
